<!-- header -->
<%- include('../partials/header') %>
<!-- end header -->

<!-- sidebar -->

<%- include('../partials/sidebar') %>

<!-- end sidebar -->
<div class="main-content app-content">
  <div class="container-fluid">
    <!-- Start::page-header -->
    <div
      class="d-flex align-items-center justify-content-between page-header-breadcrumb flex-wrap gap-2"
    >
      <div>
        <nav>
          <ol class="breadcrumb mb-1">
            <!-- <li class="breadcrumb-item">
                    <a href="javascript:void(0);"> Pages </a>
                  </li> -->
            <li class="breadcrumb-item" aria-current="page">
              <a href="javascript:void(0);">Invoice</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              Create Invoice
            </li>
          </ol>
        </nav>
        <h1 class="page-title fw-medium fs-18 mb-0" id="universal-link-name">
          Loading...
        </h1>
      </div>
      <div class="btn-list">
        <!-- <button class="btn btn-white btn-wave">
                <i class="ri-filter-3-line align-middle me-1 lh-1"></i> Filter
              </button> -->
      </div>
    </div>
    <!-- End::page-header -->

    <div class="dropdown">
      <!-- Region Dropdown -->
      <a
        href="javascript:void(0);"
        class="btn btn-sm btn-light text-muted dropdown-toggle"
        data-bs-toggle="dropdown"
        aria-expanded="true"
        id="regionDropdownBtn"
      >
        <i class="ti ti-sort-descending-2 me-1"></i>
        Choose Region
      </a>
      <ul class="dropdown-menu" id="regionDropdown" role="menu"></ul>
    
      <!-- Chapter Dropdown -->
      <a
        href="javascript:void(0);"
        class="btn btn-sm btn-light text-muted dropdown-toggle"
        data-bs-toggle="dropdown"
        aria-expanded="true"
        id="chapterDropdownBtn"
      >
        <i class="ti ti-sort-descending-2 me-1"></i>
        Choose Chapter
      </a>
      <ul class="dropdown-menu" id="chapterDropdown" role="menu"></ul>
    </div>
    
    

    <!-- Start::row-1 -->
    <div class="row">
      <div class="col-xl-9">
        <div class="card custom-card">
          <div class="card-header d-md-flex d-block">
            <div class="h5 mb-0 d-sm-flex d-block align-items-center">
              <div>
                <!-- <img
                        src=" assets/images/brand-logos/toggle-logo-5.png"
                        alt=""
                      /> -->
              </div>
              <!-- <div class="ms-sm-2 ms-0 mt-sm-0 mt-2">
                      <input
                        type="text"
                        class="form-control form-control-light form-control-sm"
                        placeholder="Invoice Title"
                        value="INV TITLE"
                      />
                    </div> -->
              <!-- <div class="mx-2">:</div> -->
              <!-- <div class="mt-sm-0 mt-2">
                      <input
                        type="text"
                        class="form-control form-control-light form-control-sm"
                        placeholder="Invoice ID"
                        value="INV ID"
                      />
                    </div> -->
            </div>
            <!-- <div class="ms-auto mt-md-0 mt-2">
              <button class="btn btn-sm btn-danger me-2">
                Save As PDF<i
                  class="ri-file-pdf-line ms-1 align-middle d-inline-block"
                ></i>
              </button>
            </div> -->
          </div>
          <div class="card-body">
            <div class="row gy-3">
              <div class="col-xl-12">
                <div class="row">
                  <div class="col-xl-4 col-lg-4 col-md-6 col-sm-6">
                    <p class="dw-semibold mb-2">Billing From :</p>
                    <div class="row gy-2">
                      <div class="col-xl-12">
                        <!-- dropdown -->
                        <select
                          class="form-select form-select-light company_info"
                        >
                          <option selected>Select Company</option>
                        </select>
                      </div>
                      <div class="col-xl-12">
                        <textarea
                          class="form-control form-control-light"
                          id="company-address"
                          placeholder="Enter Address"
                          rows="3"
                        ></textarea>
                      </div>
                      <div class="col-xl-12">
                        <input
                          type="text"
                          class="form-control form-control-light"
                          id="company-mail"
                          placeholder="Company Email"
                          value=""
                        />
                      </div>
                      <div class="col-xl-12">
                        <input
                          type="text"
                          class="form-control form-control-light"
                          id="company-phone"
                          placeholder="Phone Number"
                          value=""
                        />
                      </div>
                      <div class="col-xl-12">
                        <input
                          type="text"
                          class="form-control form-control-light"
                          id="company-gst"
                          placeholder="GST Number"
                          value=""
                        />
                      </div>
                    </div>
                  </div>
                  <div
                    class="col-xl-4 col-lg-4 col-md-6 col-sm-6 ms-auto mt-sm-0 mt-3"
                  >
                    <p class="dw-semibold mb-2">Billing To :</p>
                    <div class="row gy-2">
                      <div class="col-xl-12">
                        <select class="form-select form-select-light" id="company-name">

                          <option selected>Select Member</option>
                        </select>
                      </div>
                      <div class="col-xl-12">
                        <textarea
                          class="form-control form-control-light"
                          id="member_address"
                          placeholder="Enter Address"
                          rows="3"
                          readonly
                        ></textarea>
                      </div>
                      <div class="col-xl-12">
                        <input
                          type="text"
                          class="form-control form-control-light"
                          id="member_company_name"
                          placeholder="Customer Company Name"
                          value=""
                          readonly
                        />
                      </div>
                      <div class="col-xl-12">
                        <input
                          type="text"
                          class="form-control form-control-light"
                          id="member_phone_number"
                          placeholder="Phone Number"
                          value=""
                          readonly
                        />
                      </div>
                      <div class="col-xl-12">
                        <input
                          type="text"
                          class="form-control form-control-light"
                          id="member_gst_number"
                          placeholder="GST Number"
                          value=""
                          readonly
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-4">
                <label for="invoice-number" class="form-label"
                  >Invoice ID</label
                >
                <input
                  type="text"
                  class="form-control form-control-light"
                  id="invoice-number"
                  placeholder="Inv No"
                  value="#SHG148756965"
                />
              </div>
              <div class="col-xl-4">
                <label for="invoice-date-issued" class="form-label"
                  >Date Issued</label
                >
                <input
                  type="date"
                  class="form-control form-control-light"
                  id="invoice-date-issued"
                  placeholder="Choose date"
                />
              </div>
              <div class="col-xl-4">
                <label for="invoice-due-amount" class="form-label"
                  >Amount to be paid</label
                >
                <input
                  type="text"
                  class="form-control form-control-light grand_total"
                  id="invoice-due-amount"
                  placeholder="Enter Amount"
                  value="â‚¹ 35,784.54"
                />
              </div>
              <div class="col-xl-12">
                <div class="table-responsive">
                  <table class="table nowrap text-nowrap border mt-3">
                    <thead>
                      <tr>
                        <th>S.No.</th>
                        <th>PARTICULARS</th>
                        <th>HSN/SAC</th>
                        <th>Rate</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>
                          <input
                            type="text"
                            class="form-control form-control-light"
                            placeholder="Enter Product Name"
                          />
                        </td>
                        <td>
                          <textarea
                            rows="1"
                            class="form-control form-control-light"
                            placeholder="Enter Description"
                            name="particulars"
                            id="particulars"
                          ></textarea>
                        </td>
                        <td>
                          <input
                            class="form-control form-control-light"
                            placeholder=""
                            type="text"
                            value="999511"
                            readonly
                          />
                        </td>
                        <td>
                          <input
                            class="form-control form-control-light rate"
                            placeholder=""
                            type="text"
                            value="â‚¹ 84.00"
                            id="rate"
                          />
                        </td>
                        <td>
                          <input
                            class="form-control form-control-light price"
                            placeholder=""
                            type="text"
                            value="â‚¹ 251.00"
                            id="price"
                          />
                        </td>
                      </tr>

                      <tr>
                        <td colspan="4"></td>
                        <td colspan="2">
                          <table
                            class="table table-sm text-nowrap mb-0 table-borderless"
                          >
                            <tbody>
                              <tr>
                                <th scope="row">
                                  <div class="fw-medium">Total Taxable Value :</div>
                                </th>
                                <td>
                                  <input
                                    type="text"
                                    class="form-control form-control-light invoice-amount-input taxable-total-amount"
                                    placeholder="Enter Amount"
                                    value="â‚¹ 2519.89"
                                    id="taxable-total-amount"
                                  />
                                </td>
                              </tr>
                              <tr>
                                <th scope="row">
                                  <div class="fw-medium">
                                    Add CGST (9%)
                                    :
                                  </div>
                                </th>
                                <td>
                                  <input
                                    type="text"
                                    class="form-control form-control-light invoice-amount-input"
                                    placeholder="Enter Amount"
                                    value="â‚¹ 214.00"
                                  />
                                </td>
                              </tr>
                              <tr>
                                <th scope="row">
                                  <div class="fw-medium">
                                    Add SGST (9%)
                                    :
                                  </div>
                                </th>
                                <td>
                                  <input
                                    type="text"
                                    class="form-control form-control-light invoice-amount-input"
                                    placeholder="Enter Amount"
                                    value="â‚¹ 214.00"
                                  />
                                </td>
                              </tr>
                              <tr>
                                <th scope="row">
                                  <div class="fw-medium">
                                    Add IGST (18%)
                                    :
                                  </div>
                                </th>
                                <td>
                                  <input
                                    type="text"
                                    class="form-control form-control-light invoice-amount-input"
                                    placeholder="Enter Amount"
                                    value="â‚¹ 214.00"
                                  />
                                </td>
                              </tr>
                              <tr>
                                <th scope="row">
                                  <div class="fs-14 fw-medium">Grand Total :</div>
                                </th>
                                <td>
                                  <input
                                    type="text"
                                    class="form-control form-control-light invoice-amount-input grand_total"
                                    placeholder="Enter Amount"
                                    value="â‚¹ 2,106.68"
                                    id="grand_total"
                                  />
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div
            class="card-footer d-flex align-items-center justify-content-between gap-2"
          >
            <!-- <button class="btn btn-primary1-light">
              <i class="ri-eye-line me-1 align-middle d-inline-block"></i
              >Preview
            </button> -->
            <button class="btn btn-danger">
              Make Invoice
              <i
                class="ri-send-plane-2-line ms-1 align-middle d-inline-block"
              ></i>
            </button>
          </div>
        </div>
      </div>
      <div class="col-xl-3">
        <div class="card custom-card">
          <div class="card-header">
            <div class="card-title">Mode Of Payment</div>
          </div>
          <div class="card-body">
            <div class="row gy-3">
              <div class="col-xl-12">
                <div
                  class="btn-group"
                  role="group"
                  aria-label="Basic radio toggle button group"
                >
                  <input
                    type="radio"
                    class="btn-check"
                    name="btnradio"
                    id="btnradio2"
                  />
                  <label
                    class="btn btn-primary mt-sm-0 mt-1"
                    for="btnradio2"
                    >Cash</label
                  >
                  <!-- <input
                          type="radio"
                          class="btn-check"
                          name="btnradio"
                          id="btnradio3"
                          checked=""
                        />
                        <label
                          class="btn btn-outline-primary mt-sm-0 mt-1"
                          for="btnradio3"
                          >Credit/Debit Card</label
                        > -->
                </div>
              </div>
              <!-- <div class="col-xl-12">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="payment-status"
                    id="paid"
                    value="paid"
                  />
                  <label class="form-check-label" for="paid"> Paid </label>
                </div>

                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="payment-status"
                    id="not-paid"
                    value="not-paid"
                  />
                  <label class="form-check-label" for="not-paid">
                    Not Paid
                  </label>
                </div>

                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="payment-status"
                    id="credit"
                    value="credit"
                  />
                  <label class="form-check-label" for="credit"> Credit </label>
                </div>
              </div> -->
              <div class="col-xl-12">
                <div class="form-group">
                  <label for="payment-note">Payment Note</label>
                  <textarea
                    class="form-control"
                    id="payment-note"
                    rows="4"
                    placeholder="Enter payment details or notes here"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--End::row-1 -->
  </div>
</div>
<script src="../../assets/js/cashInvoice.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", async function () {
  try {
    // Fetch regions
    const regionResponse = await fetch("https://bni-data-backend.onrender.com/api/regions");
    const regions = await regionResponse.json();

    // Fetch chapters
    const chapterResponse = await fetch("https://bni-data-backend.onrender.com/api/chapters");
    const chapters = await chapterResponse.json();

    // Fetch members
    const memberResponse = await fetch("https://bni-data-backend.onrender.com/api/members");
    const members = await memberResponse.json();

    const regionDropdown = document.getElementById("regionDropdown");
    const regionDropdownBtn = document.getElementById("regionDropdownBtn");
    const chapterDropdown = document.getElementById("chapterDropdown");
    const chapterDropdownBtn = document.getElementById("chapterDropdownBtn");
    const memberDropdown = document.getElementById("company-name");

    // Populate region dropdown
    regions.forEach(region => {
      const regionItem = document.createElement("li");
      const regionLink = document.createElement("a");
      regionLink.className = "dropdown-item";
      regionLink.href = "javascript:void(0);";
      regionLink.textContent = region.region_name;
      regionLink.dataset.regionId = region.region_id;

      // Handle region selection
      regionLink.addEventListener("click", function () {
        regionDropdownBtn.innerHTML = `<i class="ti ti-sort-descending-2 me-1"></i> ${region.region_name}`;
        updateChapterDropdown(region.region_id, chapters);
      });

      regionItem.appendChild(regionLink);
      regionDropdown.appendChild(regionItem);
    });

    // Add "All Regions" option
    const allRegionsItem = document.createElement("li");
    const allRegionsLink = document.createElement("a");
    allRegionsLink.className = "dropdown-item";
    allRegionsLink.href = "javascript:void(0);";
    allRegionsLink.textContent = "All Regions";

    allRegionsLink.addEventListener("click", function () {
      regionDropdownBtn.innerHTML = `<i class="ti ti-sort-descending-2 me-1"></i> Choose Region`;
      updateChapterDropdown(null, chapters);
    });

    allRegionsItem.appendChild(allRegionsLink);
    regionDropdown.prepend(allRegionsItem);

    // Function to update chapters dropdown
    function updateChapterDropdown(regionId, allChapters) {
      chapterDropdown.innerHTML = "";
      chapterDropdownBtn.innerHTML = `<i class="ti ti-sort-descending-2 me-1"></i> Choose Chapter`;

      const filteredChapters = regionId ? allChapters.filter(chap => chap.region_id == regionId) : allChapters;

      filteredChapters.forEach(chapter => {
        const chapterItem = document.createElement("li");
        const chapterLink = document.createElement("a");
        chapterLink.className = "dropdown-item";
        chapterLink.href = "javascript:void(0);";
        chapterLink.textContent = chapter.chapter_name;
        chapterLink.dataset.chapterId = chapter.chapter_id;

        // Handle chapter selection
        chapterLink.addEventListener("click", function () {
          chapterDropdownBtn.innerHTML = `<i class="ti ti-sort-descending-2 me-1"></i> ${chapter.chapter_name}`;
          updateMemberDropdown(chapter.chapter_id, members);
        });

        chapterItem.appendChild(chapterLink);
        chapterDropdown.appendChild(chapterItem);
      });
    }

    // Function to update members dropdown
function updateMemberDropdown(chapterId, allMembers) {
    memberDropdown.innerHTML = `<option selected>Select Member</option>`;

    const filteredMembers = allMembers.filter(member => member.chapter_id == chapterId);

    filteredMembers.forEach(member => {
        const fullName = `${member.member_first_name} ${member.member_last_name}`.trim();
        const memberOption = document.createElement("option");
        memberOption.value = member.member_id; // Store member_id as value
        memberOption.textContent = fullName;
        memberOption.dataset.address = member.street_address_line_1; // Use correct address field
        memberOption.dataset.companyName = member.member_company_name;
        memberOption.dataset.phoneNumber = member.member_phone_number;
        memberOption.dataset.gstNumber = member.member_gst_number;

        memberDropdown.appendChild(memberOption);
    });

    // Add event listener for dropdown selection
    memberDropdown.addEventListener("change", function () {
        const selectedOption = memberDropdown.options[memberDropdown.selectedIndex];

        if (selectedOption.value !== "Select Member") {
            document.getElementById("member_address").value = selectedOption.dataset.address || "";
            document.getElementById("member_company_name").value = selectedOption.dataset.companyName || "";
            document.getElementById("member_phone_number").value = selectedOption.dataset.phoneNumber || "";
            document.getElementById("member_gst_number").value = selectedOption.dataset.gstNumber || "";
        } else {
            // Clear fields if no member is selected
            document.getElementById("member_address").value = "";
            document.getElementById("member_company_name").value = "";
            document.getElementById("member_phone_number").value = "";
            document.getElementById("member_gst_number").value = "";
        }
    });
}


    // Show all chapters by default
    updateChapterDropdown(null, chapters);

  } catch (error) {
    console.error("Error fetching data:", error);
  }
});

</script>
<script>
  document.addEventListener("DOMContentLoaded", async function () {
    try {
      // Fetch company data
      const companyResponse = await fetch("https://bni-data-backend.onrender.com/api/company");
      const companies = await companyResponse.json();

      const companyDropdown = document.querySelector(".company_info");
      const companyAddress = document.getElementById("company-address");
      const companyMail = document.getElementById("company-mail");
      const companyPhone = document.getElementById("company-phone");
      const companyGst = document.getElementById("company-gst");

      // Populate company dropdown
      companies.forEach(company => {
        const companyOption = document.createElement("option");
        companyOption.value = company.company_id; // Assuming there's a company_id field
        companyOption.textContent = company.company_name; // Assuming there's a company_name field
        companyDropdown.appendChild(companyOption);
      });

      // Event listener to update fields on company selection
      companyDropdown.addEventListener("change", function () {
        const selectedCompany = companies.find(c => c.company_id == this.value);
        if (selectedCompany) {
          companyAddress.value = selectedCompany.company_address || "";
          companyMail.value = selectedCompany.company_email || "";
          companyPhone.value = selectedCompany.company_phone || "";
          companyGst.value = selectedCompany.company_gst || "";
        } else {
          // Clear fields if no company is selected
          companyAddress.value = "";
          companyMail.value = "";
          companyPhone.value = "";
          companyGst.value = "";
        }
      });

    } catch (error) {
      console.error("Error fetching company data:", error);
    }
  });
</script>


<script>
  // Function to show the loader
  function showLoader() {
    document.getElementById("loader").style.display = "flex"; // Show loader
  }

  // Function to hide the loader
  function hideLoader() {
    document.getElementById("loader").style.display = "none"; // Hide loader
  }
  // Function to fetch and display the universal link name based on the ID
  async function fetchUniversalLinkName() {
    // Get the `id` parameter from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");
    console.log("ID from URL:", id);

    // If no ID is present, handle the error or show a default message
    if (!id) {
      document.getElementById("universal-link-name").textContent =
        "No ID found in URL";
      return;
    }

    try {
      showLoader();
      // Fetch all universal links from the API
      const response = await fetch(
        "https://bni-data-backend.onrender.com/api/universalLinks"
      );
      const data = await response.json();
      console.log("Fetched data:", data);

      // Ensure both id values are strings for comparison
      const link = data.find((link) => String(link.id) === String(id)); // Use String() for strict comparison
      console.log("Link found:", link);

      if (link) {
        // If a matching link is found, update the page title with its name
        document.getElementById("universal-link-name").textContent =
          "Make invoice for " + link.universal_link_name;
      } else {
        // If no matching link is found
        document.getElementById("universal-link-name").textContent =
          "Universal Link not found";
      }
      hideLoader();
    } catch (error) {
      console.error("Error fetching universal links:", error);
      document.getElementById("universal-link-name").textContent =
        "Error loading data";
    }
  }

  // Call the function when the page loads
  fetchUniversalLinkName();

  // Toast function
  function showToast(message) {
    alert(message);
  }
</script>

<%- include('../partials/footer') %>
