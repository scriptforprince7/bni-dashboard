<script src="/assets/js/tokenUtils.js"></script>
<script>
    (function checkAccess() {
        try {
            const loginType = getUserLoginType();
            if (loginType !== 'ro_admin') {
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f8f9fa;">
                        <div style="text-align: center; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h2 style="color: #dc3545; margin-bottom: 10px;">Unauthorized Access</h2>
                            <p style="color: #6c757d;">Only RO Admin can access this page.</p>
                            <a href="/" style="display: inline-block; margin-top: 15px; padding: 8px 16px; background-color: #0d6efd; color: white; text-decoration: none; border-radius: 4px;">Go to Home</a>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Access check failed:', error);
            window.location.href = '/';
        }
    })();
</script>
<!-- header -->
<%- include('../partials/header') %>
<!-- end header -->

<!-- sidebar -->
<%- include('../partials/sidebar') %>
<!-- end sidebar -->

<style>
  /* Ensuring that the modal body has padding */
  .modal-body {
    padding: 20px;
  }

  /* Preventing the add button container from affecting layout */
  .add-button-container {
    margin-top: 10px;
    display: none;
  }

  /* Custom dropdown style */
  .custom-dropdown {
    position: relative;
    cursor: pointer;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 5px;
  }

  .options {
    display: none;
    position: absolute;
    border: 1px solid #ccc;
    background: white;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1;
  }

  .options div {
    padding: 10px;
    display: flex;
    align-items: center;
  }

  .options div:hover {
    background-color: #f0f0f0;
  }

  .selected {
    display: flex;
    align-items: center;
  }
</style>

<!-- Start::app-content -->
<div class="main-content app-content" style="background-color: #f4f4f4">
  <div class="container-fluid">
    <!-- Start::page-header -->
    <div class="d-flex align-items-center justify-content-between page-header-breadcrumb flex-wrap gap-2">
      <div>
        <h1 class="page-title fw-medium fs-18 mb-0">
          <span style="font-weight: 700; font-family: Poppins">Add New Expense</span>
        </h1>
      </div>
    </div>
    <!-- End::page-header -->

    <form id="addExpenseForm">
      <div class="row">
        <div class="col-xl-12">
          <div class="card custom-card">
            <div class="card-body add-products">
              <div class="row gx-4">
                <div class="col-xxl-12 col-xl-12 col-lg-12 col-md-6">
                  <div class="card custom-card shadow-none mb-0 border-0">
                    <div class="card-body p-0">
                      <div class="row gy-3">
                        <div class="col-xl-12">
                          <label for="product-cost-add" class="form-label">
                            <span style="font-size: 15px"><b>It's time to add a new expense!</b></span>
                          </label>
                          <button class="btn btn-danger border" type="button" id="addNewExpenseBtn" data-region-id="123" style="float: right">
                            + Add New Expense Type
                          </button> 
                        </div>

                        <div class="col-xl-6">
                          <label for="expense_type" class="form-label">Type of Expense</label>
                          <select class="form-control" name="expense_type" id="expense_type" required>
                            <option value="">Loading...</option>
                          </select>
                        </div>
                        <div class="col-xl-6">
                          <label for="submitted_by" class="form-label">Submitted By:</label>
                          <input type="text" class="form-control" id="submitted_by" name="submitted_by" placeholder="Enter Name" maxlength="50" required />
                        </div>

                        <div class="row">
                          <div class="col-xl-6">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" placeholder="Enter description" rows="3" maxlength="200" required></textarea>
                          </div>

                          <div class="col-xl-6">
                            <label for="chapter" class="form-label">Chapter</label>
                            <select class="form-control" name="chapter" id="chapter" required>
                              <option value="">Select Chapter</option>
                            </select>
                          </div>
                        </div>

                        <!-- Hotel Selection Section (Initially Hidden) -->
                        <div id="hotelSection" style="display: none;" class="row mt-3">
                          <div class="col-xl-12">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <label for="hotel" class="form-label">Select Hotel</label>
                              <a href="/h/add-hotel" class="btn btn-danger btn-sm">+ Add New Hotel</a>
                            </div>
                            <select class="form-control" name="hotel" id="hotel">
                              <option value="">Select Hotel</option>
                            </select>
                          </div>
                        </div>

                        <!-- Vendor Selection Section (Initially Hidden) -->
                        <div id="vendorSection" style="display: none;" class="row mt-3">
                          <div class="col-xl-12">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <label for="vendor" class="form-label">Select Vendor</label>
                              <button type="button" class="btn btn-danger btn-sm" id="addNewVendorBtn">+ Add New Vendor</button>
                            </div>
                            <select class="form-control" name="vendor" id="vendor">
                              <option value="">Select Vendor</option>
                            </select>
                          </div>
                        </div>

                        <!-- Vendor Details Section (Initially Hidden) -->
                        <div id="vendorDetailsSection" style="display: none;" class="row mt-3">
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="vendor_company_name" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Company Address</label>
                            <input type="text" class="form-control" id="vendor_company_address" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="text" class="form-control" id="vendor_phone" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="text" class="form-control" id="vendor_email" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Company GST</label>
                            <input type="text" class="form-control" id="vendor_company_gst" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-control" id="vendor_bank_name" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="vendor_account" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">IFSC Code</label>
                            <input type="text" class="form-control" id="vendor_ifsc_code" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Account Type</label>
                            <input type="text" class="form-control" id="vendor_account_type" readonly />
                          </div>
                        </div>

                        <!-- Hotel Details Section (Initially Hidden) -->
                        <div id="hotelDetailsSection" style="display: none;" class="row mt-3">
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Bank Name</label>
                            <input type="text" class="form-control" id="bank_name" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">IFSC Code</label>
                            <input type="text" class="form-control" id="ifsc_code" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="account_no" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Account Type</label>
                            <input type="text" class="form-control" id="account_type" readonly />
                          </div>
                          <div class="col-xl-6 col-md-6 mb-3">
                            <label class="form-label">Hotel GST</label>
                            <input type="text" class="form-control" id="hotel_gst" readonly />
                          </div>
                        </div>

                        <div id="membershipFeesContainer" class="container">
                          <div class="row">
                            <div class="col-xl-4 col-md-4">
                              <label class="form-label" for="amount">Amount</label>
                              <input type="number" class="form-control" id="amount" name="amount" placeholder="Enter Amount" maxlength="10" required />
                              
                              <!-- Added GST Checkbox -->
                              <div class="form-check mt-2" style="margin-left: 4px;">
                                <input 
                                  type="checkbox" 
                                  class="form-check-input" 
                                  id="withGST" 
                                  name="withGST"
                                  style="cursor: pointer;"
                                />
                                <label class="form-check-label" for="withGST" style="cursor: pointer; user-select: none;">
                                  With GST
                                </label>
                              </div>

                              <!-- GST Calculation Fields (Initially Hidden) -->
                              <div id="gstCalculationFields" style="display: none;" class="mt-3">
                                <div class="row">
                                  <div class="col-4">
                                    <label class="form-label" for="gstPercentage">GST %</label>
                                    <select class="form-control" id="gstPercentage" name="gstPercentage">
                                      <option value="5">5%</option>
                                      <option value="9">9%</option>
                                      <option value="12">12%</option>
                                      <option value="18" selected>18%</option>
                                      <option value="28">28%</option>
                                    </select>
                                  </div>
                                  <div class="col-4">
                                    <label class="form-label" for="gstAmount">GST Amount</label>
                                    <input type="number" class="form-control" id="gstAmount" name="gstAmount" readonly />
                                  </div>
                                  <div class="col-4">
                                    <label class="form-label" for="totalAmount">Total Amount</label>
                                    <input type="number" class="form-control" id="totalAmount" name="totalAmount" readonly />
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="col-xl-4 col-md-4">
                              <label for="payment_status" class="form-label">Payment Status</label>
                              <select class="form-control" name="payment_status" id="payment_status">
                                <option value="">Payment Status</option>
                                <option value="paid">Paid</option>
                                <option value="pending">Pending</option>
                              </select>
                            </div>

                            <div class="col-xl-4 col-md-4">
                              <label for="payment_mode" class="form-label">Mode of Payment</label>
                              <select class="form-control" name="payment_mode" id="payment_mode" required>
                                <option value="">Select Payment Mode</option>
                                <option value="cash">Cash</option>
                                <option value="online">Online</option>
                              </select>
                            </div>

                            <div class="col-xl-4">
                              <label for="bill_date" class="form-label">Bill Date:</label>
                              <input type="date" id="bill_date" name="bill_date" class="form-control" required />
                            </div>
                          </div>

                          <div class="row">
                            <div class="col-xl-3">
                              <label for="upload_bill" class="form-label">Upload Bill</label>
                              <input type="file" class="form-control" id="upload_bill" name="upload_bill" required />
                            </div>
                            <div class="col-xl-3">
                              <label for="bill_no" class="form-label">Bill No.</label>
                              <input type="text" class="form-control" id="bill_no" name="bill_no" placeholder="Enter Bill No." maxlength="20" required/>
                            </div>
                            <div class="col-xl-3">
                              <label for="transaction_no" class="form-label">Transaction No./Transfer ID/UTR No.</label>
                              <input type="text" class="form-control" id="transaction_no" name="transaction_no" placeholder="Enter Transaction No" maxlength="20" required />
                            </div>
                            <div class="col-xl-3">
                              <label for="upload_receipt" class="form-label">Upload Receipt</label>
                              <input type="file" class="form-control" id="upload_receipt" name="upload_receipt" required />
                            </div>
                          </div>
                        </br>
                          <button type="button" id="addExpenseButton" class="btn btn-success me-2 mb-2 mb-sm-0">Add Expense</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
    <div id="formMessage"></div>
  </div>
</div>
<!-- End::content -->

<!-- Include necessary scripts in correct order -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/assets/js/tokenUtils.js"></script>
<script src="/assets/js/expense.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async function () {

  // Function to show the loader
function showLoader() {
  document.getElementById("loader").style.display = "flex"; // Show loader
}

// Function to hide the loader
function hideLoader() {
  document.getElementById("loader").style.display = "none"; // Hide loader
}
  // First get the login type and email from token
  const loginType = getUserLoginType();
  const userEmail = getUserEmail();
  
  console.log('Current user details:', {
    loginType: loginType,
    email: userEmail
  });

  // Fetch data for "Type of Expense"
  try {
    const response = await fetch("https://backend.bninewdelhi.com/api/expenseType");
    const data = await response.json();
    console.log("Expense Types:", data);
    const expenseTypeDropdown = document.getElementById("expense_type");

    // Clear existing options
    expenseTypeDropdown.innerHTML = '<option value="">Select</option>';

    // Sort data by expense_name in ascending order
    data.sort((a, b) => a.expense_name.localeCompare(b.expense_name));

    // Populate dropdown with sorted data
    data.forEach((expense) => {
      const option = document.createElement("option");
      option.value = expense.expense_id;
      option.textContent = expense.expense_name;
      expenseTypeDropdown.appendChild(option);
    });

    // Add event listener for expense type change
    expenseTypeDropdown.addEventListener('change', async function() {
      const selectedOption = this.options[this.selectedIndex];
      const hotelSection = document.getElementById('hotelSection');
      const hotelDetailsSection = document.getElementById('hotelDetailsSection');
      const vendorSection = document.getElementById('vendorSection');
      const vendorDetailsSection = document.getElementById('vendorDetailsSection');
      
      // Check if the selected expense type is "Meeting Hotel Expenses"
      if (selectedOption.textContent === 'Meeting Hotel Expenses') {
        console.log('Meeting Hotel Expenses selected - showing hotel section');
        await populateHotelDropdown();
        hotelSection.style.display = 'block';
        vendorSection.style.display = 'none';
        vendorDetailsSection.style.display = 'none';
      } else {
        console.log('Different expense type selected - showing vendor section');
        await populateVendorDropdown();
        hotelSection.style.display = 'none';
        hotelDetailsSection.style.display = 'none';
        vendorSection.style.display = 'block';
      }
    });

  } catch (error) {
    console.error("Error fetching expense types:", error);
  }

  // Function to fetch hotels
  async function fetchHotels() {
    try {
      const response = await fetch('https://backend.bninewdelhi.com/api/getHotels');
      if (!response.ok) throw new Error('Failed to fetch hotels');
      return await response.json();
    } catch (error) {
      console.error('Error fetching hotels:', error);
      throw error;
    }
  }

  // Function to populate hotel dropdown
  async function populateHotelDropdown() {
    try {
      const hotels = await fetchHotels();
      const hotelDropdown = document.getElementById('hotel');
      
      // Clear existing options
      hotelDropdown.innerHTML = '<option value="">Select Hotel</option>';
      
      // Sort hotels by name
      hotels.sort((a, b) => a.hotel_name.localeCompare(b.hotel_name));
      
      // Add hotel options
      hotels.forEach(hotel => {
        const option = document.createElement('option');
        option.value = hotel.hotel_id;
        option.textContent = hotel.hotel_name;
        hotelDropdown.appendChild(option);
      });
    } catch (error) {
      console.error('Error populating hotel dropdown:', error);
      Swal.fire('Error!', 'Failed to load hotels', 'error');
    }
  }

  // Function to handle hotel selection
  async function handleHotelSelection(hotelId) {
    try {
      const hotels = await fetchHotels();
      const selectedHotel = hotels.find(hotel => hotel.hotel_id === parseInt(hotelId));
      
      if (selectedHotel) {
        // Populate hotel details fields
        document.getElementById('bank_name').value = selectedHotel.bank_name || 'N/A';
        document.getElementById('ifsc_code').value = selectedHotel.ifsc_code || 'N/A';
        document.getElementById('account_no').value = selectedHotel.account_no || 'N/A';
        document.getElementById('account_type').value = selectedHotel.account_type || 'N/A';
        document.getElementById('hotel_gst').value = selectedHotel.hotel_gst || 'N/A';
        
        // Show hotel details section
        document.getElementById('hotelDetailsSection').style.display = 'flex';
      }
    } catch (error) {
      console.error('Error handling hotel selection:', error);
      Swal.fire('Error!', 'Failed to load hotel details', 'error');
    }
  }

  // Add event listener for hotel selection
  document.getElementById('hotel').addEventListener('change', function() {
    const selectedHotelId = this.value;
    const hotelDetailsSection = document.getElementById('hotelDetailsSection');
    
    if (selectedHotelId) {
      handleHotelSelection(selectedHotelId);
    } else {
      hotelDetailsSection.style.display = 'none';
    }
  });

  // GST Calculation Logic
  const withGSTCheckbox = document.getElementById('withGST');
  const amountInput = document.getElementById('amount');
  const gstCalculationFields = document.getElementById('gstCalculationFields');
  const gstPercentageSelect = document.getElementById('gstPercentage');
  const gstAmountInput = document.getElementById('gstAmount');
  const totalAmountInput = document.getElementById('totalAmount');

  // Function to calculate GST and total
  function calculateGST() {
    const amount = parseFloat(amountInput.value) || 0;
    const gstPercentage = parseFloat(gstPercentageSelect.value) / 100;

    if (withGSTCheckbox.checked) {
      const gstAmount = amount * gstPercentage;
      const totalAmount = amount + gstAmount;

      // Update the fields with formatted numbers
      gstAmountInput.value = gstAmount.toFixed(2);
      totalAmountInput.value = totalAmount.toFixed(2);
      gstCalculationFields.style.display = 'block';
    } else {
      gstCalculationFields.style.display = 'none';
      gstAmountInput.value = '';
      totalAmountInput.value = '';
    }
  }

  // Add event listeners for GST calculation
  withGSTCheckbox.addEventListener('change', calculateGST);
  amountInput.addEventListener('input', function() {
    if (withGSTCheckbox.checked) {
      calculateGST();
    }
  });
  gstPercentageSelect.addEventListener('change', function() {
    if (withGSTCheckbox.checked) {
      calculateGST();
    }
  });

  // Fetch and populate chapters dropdown
  try {
    console.log('Fetching chapters data...');
    const response = await fetch("https://backend.bninewdelhi.com/api/chapters");
    const chapters = await response.json();
    console.log("All available chapters:", chapters);

    const chapterDropdown = document.getElementById("chapter");
    chapterDropdown.innerHTML = '<option value="">Select Chapter</option>';

    // Filter chapters based on login type and email
    let filteredChapters = [];
    if (loginType === 'ro_admin') {
      console.log('User is RO Admin - showing all chapters');
      filteredChapters = chapters;
    } else {
      console.log('User is not RO Admin - filtering chapters by email');
      filteredChapters = chapters.filter(
  chapter =>
    chapter.email_id === userEmail ||
    chapter.vice_president_mail === userEmail ||
    chapter.president_mail === userEmail ||
    chapter.treasurer_mail === userEmail
);

      console.log('Filtered chapters by email:', filteredChapters);
    }

    // Sort filtered chapters by name
    filteredChapters.sort((a, b) => a.chapter_name.localeCompare(b.chapter_name));
    console.log('Sorted chapters to display:', filteredChapters);

    // Populate dropdown with filtered chapters
    if (filteredChapters.length > 0) {
      filteredChapters.forEach((chapter) => {
        const option = document.createElement("option");
        option.value = chapter.chapter_id;
        option.textContent = chapter.chapter_name;
        chapterDropdown.appendChild(option);
        console.log(`Added chapter to dropdown: ${chapter.chapter_name} (ID: ${chapter.chapter_id})`);
      });
    } else {
      console.log('No chapters available for this user');
      const option = document.createElement("option");
      option.value = "";
      option.textContent = "No chapters available";
      chapterDropdown.appendChild(option);
    }

  } catch (error) {
    console.error("Error in chapter dropdown population:", error);
    const chapterDropdown = document.getElementById("chapter");
    chapterDropdown.innerHTML = '<option value="">Error loading chapters</option>';
  }

  // Function to fetch vendors
  async function fetchVendors() {
    try {
      const response = await fetch('http://localhost:5000/api/getAllVendors');
      if (!response.ok) throw new Error('Failed to fetch vendors');
      return await response.json();
    } catch (error) {
      console.error('Error fetching vendors:', error);
      throw error;
    }
  }

  // Function to populate vendor dropdown based on selected chapter
  async function populateVendorDropdown(selectedChapterId = null) {
    try {
      const vendors = await fetchVendors();
      const vendorDropdown = document.getElementById('vendor');
      
      // Clear existing options
      vendorDropdown.innerHTML = `
        <option value="">Select Vendor</option>
        <option value="all">All Vendors</option>
        <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
      `;
      
      // Filter vendors by chapter_id if a chapter is selected and "All Vendors" is not selected
      let filteredVendors = vendors;
      if (selectedChapterId && selectedChapterId !== 'all') {
        filteredVendors = vendors.filter(vendor => 
          vendor.chapter_id === parseInt(selectedChapterId)
        );

        // Add a subheading for chapter vendors if any exist
        if (filteredVendors.length > 0) {
          const optgroup = document.createElement('optgroup');
          optgroup.label = 'Chapter Vendors';
          vendorDropdown.appendChild(optgroup);
          
          // Add chapter vendors
          filteredVendors.forEach(vendor => {
            const option = document.createElement('option');
            option.value = vendor.vendor_id;
            option.textContent = `${vendor.vendor_name} - ${vendor.vendor_company_name}`;
            optgroup.appendChild(option);
          });
        }

        // Add a separator and option to show other vendors
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
        vendorDropdown.appendChild(separator);

        // Add option to show other vendors
        const showOthersOption = document.createElement('option');
        showOthersOption.value = 'show_others';
        showOthersOption.textContent = 'âž• Show Other Chapter Vendors';
        vendorDropdown.appendChild(showOthersOption);

      } else {
        // If no chapter selected or "All Vendors" is selected, show all vendors
        vendors.sort((a, b) => a.vendor_name.localeCompare(b.vendor_name));
        vendors.forEach(vendor => {
          const option = document.createElement('option');
          option.value = vendor.vendor_id;
          option.textContent = `${vendor.vendor_name} - ${vendor.vendor_company_name}`;
          vendorDropdown.appendChild(option);
        });
      }

      // If no vendors found at all
      if (vendors.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "No vendors found";
        vendorDropdown.appendChild(option);
      }
    } catch (error) {
      console.error('Error populating vendor dropdown:', error);
      Swal.fire('Error!', 'Failed to load vendors', 'error');
    }
  }

  // Function to show other chapter vendors
  async function showOtherChapterVendors() {
    try {
      const vendors = await fetchVendors();
      const vendorDropdown = document.getElementById('vendor');
      const selectedChapterId = document.getElementById('chapter').value;

      // Remove the "Show Other Chapter Vendors" option
      const showOthersOption = vendorDropdown.querySelector('option[value="show_others"]');
      if (showOthersOption) {
        showOthersOption.remove();
      }

      // Add other vendors in a separate group
      const otherVendors = vendors.filter(vendor => 
        vendor.chapter_id !== parseInt(selectedChapterId)
      );

      if (otherVendors.length > 0) {
        const otherOptgroup = document.createElement('optgroup');
        otherOptgroup.label = 'Other Chapter Vendors';
        vendorDropdown.appendChild(otherOptgroup);

        // Sort other vendors by name
        otherVendors.sort((a, b) => a.vendor_name.localeCompare(b.vendor_name));

        otherVendors.forEach(vendor => {
          const option = document.createElement('option');
          option.value = vendor.vendor_id;
          option.textContent = `${vendor.vendor_name} - ${vendor.vendor_company_name}`;
          otherOptgroup.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Error showing other chapter vendors:', error);
      Swal.fire('Error!', 'Failed to load other vendors', 'error');
    }
  }

  // Function to handle vendor selection
  async function handleVendorSelection(vendorId) {
    try {
      const vendors = await fetchVendors();
      const selectedVendor = vendors.find(vendor => vendor.vendor_id === parseInt(vendorId));
      
      if (selectedVendor) {
        // Populate vendor details fields
        document.getElementById('vendor_company_name').value = selectedVendor.vendor_company_name || 'N/A';
        document.getElementById('vendor_company_address').value = selectedVendor.vendor_company_address || 'N/A';
        document.getElementById('vendor_phone').value = selectedVendor.phone_number || 'N/A';
        document.getElementById('vendor_email').value = selectedVendor.email_id || 'N/A';
        document.getElementById('vendor_company_gst').value = selectedVendor.vendor_company_gst || 'N/A';
        document.getElementById('vendor_bank_name').value = selectedVendor.vendor_bank_name || 'N/A';
        document.getElementById('vendor_account').value = selectedVendor.vendor_account || 'N/A';
        document.getElementById('vendor_ifsc_code').value = selectedVendor.vendor_ifsc_code || 'N/A';
        document.getElementById('vendor_account_type').value = selectedVendor.vendor_account_type || 'N/A';
        
        // Show vendor details section
        document.getElementById('vendorDetailsSection').style.display = 'flex';
      }
    } catch (error) {
      console.error('Error handling vendor selection:', error);
      Swal.fire('Error!', 'Failed to load vendor details', 'error');
    }
  }

  // Add event listener for vendor dropdown
  document.getElementById('vendor').addEventListener('change', function() {
    const selectedVendorId = this.value;
    const vendorDetailsSection = document.getElementById('vendorDetailsSection');
    
    if (selectedVendorId === 'show_others') {
      // Show other chapter vendors
      showOtherChapterVendors();
      // Reset selection to first option
      this.selectedIndex = 0;
    } else if (selectedVendorId && selectedVendorId !== 'all') {
      handleVendorSelection(selectedVendorId);
    } else {
      vendorDetailsSection.style.display = 'none';
    }
  });

  // Add event listener for chapter selection
  document.getElementById('chapter').addEventListener('change', function() {
    const selectedChapterId = this.value;
    const expenseType = document.getElementById('expense_type');
    const selectedExpenseType = expenseType.options[expenseType.selectedIndex].textContent;
    const vendorDetailsSection = document.getElementById('vendorDetailsSection');

    // Only update vendor dropdown if expense type is not "Meeting Hotel Expenses"
    if (selectedExpenseType !== 'Meeting Hotel Expenses') {
      populateVendorDropdown(selectedChapterId);
      // Hide vendor details when chapter changes
      vendorDetailsSection.style.display = 'none';
    }
  });

  const addExpenseButton = document.getElementById("addExpenseButton");

  addExpenseButton.addEventListener("click", async function () {
    const form = document.getElementById("addExpenseForm");
    const formData = new FormData(form);

    // Validate file upload
    const fileInput = document.getElementById('upload_bill');
    const file = fileInput.files[0];
    
    // File validation
    if (!file) {
        Swal.fire('Error!', 'Please select a bill file', 'error');
        return;
    }

    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!allowedTypes.includes(file.type)) {
        Swal.fire('Error!', 'Only JPG, PNG and PDF files are allowed', 'error');
        return;
    }

    // Validate file size (5MB limit)
    const maxSize = 5 * 1024 * 1024; // 5MB in bytes
    if (file.size > maxSize) {
        Swal.fire('Error!', 'File size should not exceed 5MB', 'error');
        return;
    }

    // Get selected chapter and convert ID to number
    const selectedChapter = document.getElementById("chapter");
    const selectedChapterId = parseInt(selectedChapter.value, 10);
    
    // Validate chapter selection
    if (!selectedChapterId || isNaN(selectedChapterId)) {
      Swal.fire('Error!', 'Please select a valid chapter', 'error');
      console.error('Invalid chapter selection:', {
        originalValue: selectedChapter.value,
        parsedValue: selectedChapterId
      });
      return;
    }

    // Clear and append form data
    formData.delete('chapter_id');
    formData.append('chapter_id', selectedChapterId);

    // Debug: Log form data before sending
    console.log('ðŸ“¤ Sending Form Data:', {
        expense_type: parseInt(document.getElementById('expense_type').value, 10),
        submitted_by: document.getElementById('submitted_by').value,
        description: document.getElementById('description').value,
        chapter_id: selectedChapterId,
        amount: parseFloat(document.getElementById('amount').value),
        withGST: document.getElementById('withGST').checked,
        gstPercentage: document.getElementById('withGST').checked ? parseFloat(document.getElementById('gstPercentage').value) : 0,
        gstAmount: document.getElementById('withGST').checked ? parseFloat(document.getElementById('gstAmount').value) : 0,
        totalAmount: document.getElementById('withGST').checked ? parseFloat(document.getElementById('totalAmount').value) : parseFloat(document.getElementById('amount').value),
        payment_status: document.getElementById('payment_status').value,
        payment_mode: document.getElementById('payment_mode').value,
        bill_date: document.getElementById('bill_date').value,
        bill_no: document.getElementById('bill_no').value,
        transaction_no: document.getElementById('transaction_no').value,
        file: {
            name: file.name,
            type: file.type,
            size: file.size
        }
    });

    try {
        showLoader();
        
        // Add GST-related values to formData
        formData.append('withGST', document.getElementById('withGST').checked);
        if (document.getElementById('withGST').checked) {
            formData.append('gstPercentage', document.getElementById('gstPercentage').value);
            formData.append('gstAmount', document.getElementById('gstAmount').value);
            formData.append('totalAmount', document.getElementById('totalAmount').value);
        }

        const response = await fetch("http://localhost:5000/api/addExpense", {
            method: "POST",
            body: formData, // FormData now includes withGST value
        });

        if (response.ok) {
            const data = await response.json();
            console.log('âœ… API Response:', data);
            
            Swal.fire({
                title: 'Success!',
                text: data.message,
                icon: 'success',
                confirmButtonText: 'OK'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/rexp/view-expenses';
                }
            });
            form.reset();
        } else {
            const errorResponse = await response.json();
            console.error('âŒ API Error:', errorResponse);
            Swal.fire('Failed!', errorResponse.message, 'error');
        }
    } catch (error) {
        console.error('âŒ Error:', error);
        Swal.fire('Error!', 'Failed to add expense. Please try again.', 'error');
    } finally {
        hideLoader();
    }
  });

  // Function to add new vendor
  const addNewVendor = async () => {
    // First fetch chapters for the dropdown
    try {
      const chaptersResponse = await fetch("https://backend.bninewdelhi.com/api/chapters");
      const chapters = await chaptersResponse.json();
      
      // Sort chapters alphabetically
      chapters.sort((a, b) => a.chapter_name.localeCompare(b.chapter_name));
      
      // Create chapter options HTML
      const chapterOptions = chapters.map(chapter => 
        `<option value="${chapter.chapter_id}">${chapter.chapter_name}</option>`
      ).join('');

      const result = await Swal.fire({
        title: 'Add New Vendor',
        html: `
          <form id="addVendorForm" class="text-start">
            <div class="mb-3">
              <label for="vendor_name" class="form-label">Vendor Name</label>
              <input type="text" class="form-control" id="vendor_name">
            </div>
            <div class="mb-3">
              <label for="chapter_id" class="form-label">Choose Chapter</label>
              <select class="form-control" id="chapter_id" required>
                <option value="">Select Chapter</option>
                ${chapterOptions}
              </select>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="phone_number" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phone_number">
              </div>
              <div class="col-md-6">
                <label for="email_id" class="form-label">Email</label>
                <input type="email" class="form-control" id="email_id">
              </div>
            </div>
            <div class="mb-3">
              <label for="vendor_company_name" class="form-label">Company Name</label>
              <input type="text" class="form-control" id="vendor_company_name">
            </div>
            <div class="mb-3">
              <label for="vendor_company_address" class="form-label">Company Address</label>
              <textarea class="form-control" id="vendor_company_address" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="vendor_company_gst" class="form-label">Company GST</label>
              <input type="text" class="form-control" id="vendor_company_gst">
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="vendor_bank_name" class="form-label">Bank Name</label>
                <input type="text" class="form-control" id="vendor_bank_name">
              </div>
              <div class="col-md-6">
                <label for="vendor_account" class="form-label">Account Number</label>
                <input type="text" class="form-control" id="vendor_account">
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="vendor_ifsc_code" class="form-label">IFSC Code</label>
                <input type="text" class="form-control" id="vendor_ifsc_code">
              </div>
              <div class="col-md-6">
                <label for="vendor_account_type" class="form-label">Account Type</label>
                <select class="form-control" id="vendor_account_type">
                  <option value="">Select Account Type</option>
                  <option value="Savings">Savings</option>
                  <option value="Current">Current</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="vendor_status" class="form-label">Status</label>
              <select class="form-control" id="vendor_status">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </form>
        `,
        showCancelButton: true,
        confirmButtonText: 'Add Vendor',
        cancelButtonText: 'Cancel',
        width: '800px',
        customClass: {
          container: 'add-vendor-popup'
        },
        didOpen: () => {
          // Add input masks for uppercase conversion
          const gstInput = document.getElementById('vendor_company_gst');
          gstInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
          });

          const ifscInput = document.getElementById('vendor_ifsc_code');
          ifscInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
          });
        },
        preConfirm: () => {
          const chapterId = document.getElementById('chapter_id').value;
          if (!chapterId) {
            Swal.showValidationMessage('Please select a chapter');
            return false;
          }

          // Get form values
          const vendorData = {
            vendor_name: document.getElementById('vendor_name').value || '',
            chapter_id: parseInt(chapterId),
            phone_number: document.getElementById('phone_number').value || '',
            email_id: document.getElementById('email_id').value || '',
            vendor_company_name: document.getElementById('vendor_company_name').value || '',
            vendor_company_address: document.getElementById('vendor_company_address').value || '',
            vendor_company_gst: document.getElementById('vendor_company_gst').value || '',
            vendor_account: document.getElementById('vendor_account').value || '',
            vendor_bank_name: document.getElementById('vendor_bank_name').value || '',
            vendor_ifsc_code: document.getElementById('vendor_ifsc_code').value || '',
            vendor_account_type: document.getElementById('vendor_account_type').value || '',
            vendor_status: document.getElementById('vendor_status').value || 'active'
          };

          // Log the data being sent
          console.log('Sending vendor data:', vendorData);

          return vendorData;
        }
      });

      if (result.isConfirmed && result.value) {
        try {
          showLoader();
          const response = await fetch('http://localhost:5000/api/addVendor', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(result.value)
          });

          if (response.ok) {
            const data = await response.json();
            await Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: data.message || 'Vendor added successfully',
              timer: 2000,
              showConfirmButton: false
            });
            // Refresh vendor dropdown with current chapter selection
            const currentChapterId = document.getElementById('chapter').value;
            await populateVendorDropdown(currentChapterId);
          } else {
            const errorData = await response.json();
            Swal.fire('Error!', errorData.message || 'Failed to add vendor', 'error');
          }
        } catch (error) {
          console.error('Error adding vendor:', error);
          Swal.fire('Error!', 'Failed to add vendor. Please try again.', 'error');
        } finally {
          hideLoader();
        }
      }
    } catch (error) {
      console.error('Error fetching chapters:', error);
      Swal.fire('Error!', 'Failed to load chapters. Please try again.', 'error');
    }
  };

  // Add event listener for Add New Vendor button
  document.getElementById('addNewVendorBtn').addEventListener('click', addNewVendor);
});

// Helper function to check if arrays are equal (for debugging)
function arraysEqual(a, b) {
  if (a === b) return true;
  if (a == null || b == null) return false;
  if (a.length !== b.length) return false;
  for (let i = 0; i < a.length; ++i) {
    if (a[i] !== b[i]) return false;
  }
  return true;
}
</script>

<%- include('../partials/footer') %>
