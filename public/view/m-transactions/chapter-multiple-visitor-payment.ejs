<!-- header -->
<%- include('../partials/header') %>
<!-- end header -->

<!-- Add Toastify CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>


<!-- sidebar -->
<style>
  /* Style for dropdown menu to enable scrolling */
.dropdown-menu {
max-height: 200px; /* Adjust the height as needed */
overflow-y: auto;  /* Enables vertical scrolling */
overflow-x: hidden; /* Prevents horizontal scrolling */
}

/* Visitors Table Styles */
#visitorsTable {
  margin-bottom: 0;
}

#visitorsTable th {
  background-color: #f8f9fa;
  font-weight: 600;
  white-space: nowrap;
}

#visitorsTable td {
  vertical-align: middle;
}

#visitorsTable input {
  width: 100%;
  border: 1px solid #e9ecef;
  padding: 0.375rem 0.75rem;
  border-radius: 0.25rem;
}

#visitorsTable input:focus {
  border-color: #6259ca;
  box-shadow: 0 0 0 0.2rem rgba(98, 89, 202, 0.25);
}

.visitor-row-actions {
  white-space: nowrap;
}

.visitor-row-actions .btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

/* Template for visitor row (hidden) */
#visitorRowTemplate {
  display: none;
}

.btn-group .btn-outline-primary {
  border-color: #6259ca;
  color: #6259ca;
}

.btn-group .btn-check:checked + .btn-outline-primary {
  background-color: #6259ca;
  border-color: #6259ca;
  color: white;
}

.btn-group .btn-outline-secondary {
  border-color: #7987a1;
  color: #7987a1;
}

.btn-group .btn-check:checked + .btn-outline-secondary {
  background-color: #7987a1;
  border-color: #7987a1;
  color: white;
}

.payment-fields {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.payment-type-options {
  margin-bottom: 15px;
  padding: 10px;
  border-radius: 5px;
  background-color: #f8f9fa;
}

.payment-type-options .form-check {
  margin-right: 20px;
  display: inline-block;
}

.payment-type-options .form-check-input:checked + .form-check-label {
  font-weight: bold;
  color: #6259ca;
}

#new-member-details-form .form-label i {
  color: #6259ca;
  font-size: 1.1em;
}
#new-member-details-form .card {
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(98,89,202,0.08);
}
#new-member-details-form input.form-control {
  border-radius: 8px;
}
</style>

<!-- Add ToastContainer div -->
<div id="toast-container"></div>

<!-- Initialize Toastify -->
<script>
// Initialize toast configuration
window.toast = {
  error: function(message) {
    Toastify({
      text: message,
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: "#ff6b6b",
      close: true,
      stopOnFocus: true
    }).showToast();
  },
  success: function(message) {
    Toastify({
      text: message,
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: "#51cf66",
      close: true,
      stopOnFocus: true
    }).showToast();
  },
  warning: function(message) {
    Toastify({
      text: message,
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: "#fcc419",
      close: true,
      stopOnFocus: true
    }).showToast();
  }
};
</script>

<%- include('../partials/chapter-sidebar') %>

<!-- end sidebar -->
<div class="main-content app-content">
  <div class="container-fluid">
    <!-- Start::page-header -->
    <div
      class="d-flex align-items-center justify-content-between page-header-breadcrumb flex-wrap gap-2"
    >
      <div>
        <nav>
          <ol class="breadcrumb mb-1">
            <!-- <li class="breadcrumb-item">
                    <a href="javascript:void(0);"> Pages </a>
                  </li> -->
            <li class="breadcrumb-item" aria-current="page">
              <a href="javascript:void(0);">Invoice</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              Create Invoice
            </li>
          </ol>
        </nav>
        <h1 class="page-title fw-medium fs-18 mb-0" id="universal-link-name">
          
        </h1>
      </div>
      <div class="btn-list">
        <!-- <button class="btn btn-white btn-wave">
                <i class="ri-filter-3-line align-middle me-1 lh-1"></i> Filter
              </button> -->
      </div>
    </div>
    <!-- End::page-header -->

    <div class="dropdown">
      <!-- Region Dropdown -->
      <a
        href="javascript:void(0);"
        class="btn btn-sm btn-light text-muted dropdown-toggle"
        data-bs-toggle="dropdown"
        aria-expanded="true"
        id="regionDropdownBtn"
      >
        <i class="ti ti-sort-descending-2 me-1"></i>
        Choose Region
      </a>
      <ul class="dropdown-menu" id="regionDropdown" role="menu"></ul>
    
      <!-- Chapter Dropdown -->
      <a
        href="javascript:void(0);"
        class="btn btn-sm btn-light text-muted dropdown-toggle"
        data-bs-toggle="dropdown"
        aria-expanded="true"
        id="chapterDropdownBtn"
      >
        <i class="ti ti-sort-descending-2 me-1"></i>
        Choose Chapter
      </a>
      <ul class="dropdown-menu" id="chapterDropdown" role="menu"></ul>
    </div>
    
    <!-- Multiple Visitors Entry Section -->
    <div class="card custom-card mt-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Visitor Entries</h5>
        <button class="btn btn-primary" id="addVisitorBtn">
          <i class="ti ti-plus me-1"></i>Add Visitor
        </button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered" id="visitorsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Mobile</th>
                <th>Address</th>
                <th>Business Category</th>
                <th>Visitor State</th>
                <th>Visitor Pincode</th>
                <th>Invited by</th>
                <th>GSTIN</th>
                <th>Company Name</th>
                
                <th>Company Address</th>
                <th>Mode of Payment</th>
                <th>Date Issued</th>
                <th>Include GST</th>
                <th>GST Amount</th>
                <th>Final Amount</th>

              </tr>
            </thead>
            <tbody id="visitorsTableBody">
              <!-- Visitor rows will be added here dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Template for visitor row -->
    <template id="visitorRowTemplate">
      <tr class="visitor-row">
        <td><input type="text" class="form-control visitor-name" placeholder="Enter name"></td>
        <td><input type="email" class="form-control visitor-email" placeholder="Enter email"></td>
        <td><input type="tel" class="form-control visitor-mobile" placeholder="Enter mobile"></td>
        <td><input type="text" class="form-control visitor-address" placeholder="Enter address"></td>
        <td><input type="text" class="form-control visitor-category" placeholder="Enter category"></td>
        <td><input type="text" class="form-control visitor-company" placeholder="Enter company"></td>
        <td><input type="text" class="form-control visitor-gstin" placeholder="Enter GSTIN"></td>
        <td><input type="text" class="form-control visitor-company-address" placeholder="Enter company address"></td>
        <td class="visitor-row-actions">
          <button type="button" class="btn btn-danger btn-sm delete-visitor">
            <i class="ti ti-trash"></i>
          </button>
        </td>
      </tr>
    </template>

    <div id="membership-dropdown-container"></div>
    <!-- Add this after the chapterDropdown UL -->
    <div id="payment-type-radio-container"></div>

    <!-- Payment Type Options (for meeting payments) -->
    <div id="payment-type-options" class="payment-type-options" style="display: none;">
      <div class="row">
        <div class="col-md-8">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="paymentType" id="fullPaymentOption" value="full" checked>
            <label class="form-check-label" for="fullPaymentOption">Full Payment</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="paymentType" id="partialPaymentOption" value="partial">
            <label class="form-check-label" for="partialPaymentOption">Partial Payment</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="paymentType" id="advancePaymentOption" value="advance">
            <label class="form-check-label" for="advancePaymentOption">Advance Payment</label>
          </div>
        </div>
        <div class="col-md-4">
          <div id="kitty-bill-type" style="display: none;">
            <div class="alert alert-info mb-0 py-2">
              <p class="mb-0"><strong>Bill Type:</strong> <span id="bill-type"></span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Visitor/Member Details Form (Visible only for id=1) -->
<div id="new-member-details-form" style="display: none; margin-top: 24px;">
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h5 class="mb-4" style="font-weight: 600;">
        <i class="ti ti-user me-2"></i> New Member Details
      </h5>
      <form class="row g-3">
        <div class="col-md-6">
          <label class="form-label"><i class="ti ti-user me-1"></i>Name</label>
          <input type="text" class="form-control" id="nm-name" placeholder="Enter Name" autocomplete="off">
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="ti ti-mail me-1"></i>Email</label>
          <input type="email" class="form-control" id="nm-email" placeholder="Enter Email" autocomplete="off">
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="ti ti-tag me-1"></i>Category</label>
          <input type="text" class="form-control" id="nm-category" placeholder="Enter Category" autocomplete="off">
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="ti ti-calendar me-1"></i>Date</label>
          <input type="date" class="form-control" id="nm-date" autocomplete="off">
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="ti ti-phone me-1"></i>Mobile Number</label>
          <input type="tel" class="form-control" id="nm-mobile" placeholder="Enter Mobile Number" autocomplete="off">
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="ti ti-building me-1"></i>Company Name</label>
          <input type="text" class="form-control" id="nm-company-name" placeholder="Enter Company Name" autocomplete="off">
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="ti ti-file-text me-1"></i>Company GSTIN</label>
          <input type="text" class="form-control" id="nm-company-gstin" placeholder="Enter GSTIN" autocomplete="off">
        </div>
        <div class="col-md-6">
          <label class="form-label"><i class="ti ti-map-pin me-1"></i>Company Address</label>
          <input type="text" class="form-control" id="nm-company-address" placeholder="Enter Company Address" autocomplete="off">
        </div>
      </form>
    </div>
  </div>
</div>

    <!-- Detailed Kitty Bill Info (Moved to top) -->
    <div id="kitty-bill-info" style="display: none;" class="mb-3">
      <div class="alert alert-info">
        <h6 class="mb-2">Kitty Bill Details</h6>
        <div class="row">
          <div class="col-md-3">
            <p class="mb-1"><strong>Description:</strong> <span id="bill-description"></span></p>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Amount:</strong> <span id="bill-amount"></span></p>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Due Date:</strong> <span id="bill-due-date"></span></p>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Penalty Fee:</strong> <span id="bill-penalty"></span></p>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-12">
            <p class="mb-0">Bill Status: <span id="bill-status"></span></p>
          </div>
        </div>
      </div>
    </div>

    <!-- No Kitty Bill Message -->
    <div id="no-kitty-bill-message" style="display: none;" class="mb-3">
      <div class="alert alert-warning">
        <h6 class="mb-0">No kitty bill raised for this chapter</h6>
      </div>
    </div>

    <!-- Chapter Selection Message (Only for meeting payments) -->
    <div id="chapter-selection-message" class="mb-3" style="display: none;">
      <div class="alert alert-info">
        <h6 class="mb-0">Please select a chapter to view kitty bill details</h6>
      </div>
    </div>

    <!-- After the existing billing section and before the table -->
    <div id="visitor-details-section" style="display: none;" class="mt-4 mb-4">
      <div class="row">
        <div class="col-xl-6">
          <div class="card custom-card">
            <div class="card-body">
              <div class="row gy-3">
                <div class="col-xl-12">
                  <label class="form-label">Visitor Name</label>
                  <input type="text" class="form-control form-control-light" id="visitor-name" placeholder="Enter Visitor Name">
                </div>
                <div class="col-xl-12">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control form-control-light" id="visitor-email" placeholder="Enter Email">
                </div>
                <div class="col-xl-12">
                  <label class="form-label">Visitor Mobile Number</label>
                  <input type="tel" class="form-control form-control-light" id="visitor-mobile" placeholder="Enter Mobile Number">
                </div>
                <div class="col-xl-12">
                  <label class="form-label">Member Address</label>
                  <textarea class="form-control form-control-light" id="visitor-address" rows="3" placeholder="Enter Address"></textarea>
                </div>
                <div class="col-xl-12">
                  <label class="form-label">Category</label>
                  <input 
                    type="text" 
                    class="form-control form-control-light" 
                    id="visitor-category" 
                    placeholder="Enter Visitor Category"
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-6">
          <div class="card custom-card">
            <div class="card-body">
              <div class="row gy-3">
                <div class="col-xl-12">
                  <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="has-gst">
                    <label class="form-check-label" for="has-gst">Has GST</label>
                  </div>
                </div>
                <!-- GST Fields (Initially Hidden) -->
                <div id="gst-fields" style="display: none;">
                  <div class="col-xl-12">
                    <div class="mb-3">
                      <label class="form-label">Company GSTIN</label>
                      <div class="input-group">
                        <input type="text" class="form-control form-control-light" id="company-gstin" placeholder="Enter GSTIN">
                        <button class="btn btn-primary" type="button" id="get-gst-details">
                          Get GST Details
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="col-xl-12">
                    <div class="mb-3">
                      <label class="form-label">Company Name</label>
                      <input type="text" class="form-control form-control-light" id="visitor-company-name" placeholder="Enter Company Name">
                    </div>
                  </div>
                  <div class="col-xl-12">
                    <div class="mb-3">
                      <label class="form-label">Company Address</label>
                      <textarea class="form-control form-control-light" id="visitor-company-address" rows="3" placeholder="Company Address"></textarea>
                    </div>
                  </div>
                </div>
                <!-- <div class="col-xl-12">
                  <label class="form-label">Date</label>
                  <input type="date" class="form-control form-control-light" id="visitor-date">
                </div> -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button class="btn btn-danger" id="submit_invoice">
      Review and Submit
      <i
        class="ri-send-plane-2-line ms-1 align-middle d-inline-block submit_invoice"
        
      ></i>
    </button>

    <!-- Start::row-1 -->
    
    <!--End::row-1 -->
  </div>
</div>

<!-- Move all script tags to the end, just before closing body tag -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../../assets/js/chapterMultipleVisitorsPayment.js"></script>

<!-- Add a check to prevent both scripts from loading simultaneously -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('id') === '1') {
      // Show the new member details form
      document.getElementById('new-member-details-form').style.display = 'block';
    }
  });
</script>

<!-- <script>
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('id') === '4') {
        // Load only kittyPaymentsInvoice.js for meeting payments
        document.write('<script src="../../assets/js/kittyPaymentsInvoice.js"><\/script>');
    } 
     else if (urlParams.get('id') === '5') {
        // Load cashInvoice.js for other cases
        document.write('<script src="../../assets/js/cashInvoice.js"><\/script>');
    }else{
      // Load newMemberPayment.js for other cases
      document.write('<script src="../../assets/js/newMemberPayment.js"><\/script>');
    }
</script> -->

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', async function() {
  // Payment method handling
  const paymentMethods = document.getElementsByName('paymentMethod');
  const upiFields = document.getElementById('upiFields');
  const bankFields = document.getElementById('bankFields');
  const chequeFields = document.getElementById('chequeFields');
  const impsFields = document.getElementById('impsFields');

  if (paymentMethods.length > 0) {
    paymentMethods.forEach(method => {
      method.addEventListener('change', function() {
        // Hide all payment fields first
        if (upiFields) upiFields.style.display = 'none';
        if (bankFields) bankFields.style.display = 'none';
        if (chequeFields) chequeFields.style.display = 'none';
        if (impsFields) impsFields.style.display = 'none';

        // Show relevant fields based on selection
        if (this.id === 'upiOption' && upiFields) {
          upiFields.style.display = 'block';
        } else if (this.id === 'bankOption' && bankFields) {
          bankFields.style.display = 'block';
        } else if (this.id === 'chequeOption' && chequeFields) {
          chequeFields.style.display = 'block';
        } else if (this.id === 'impsOption' && impsFields) {
          impsFields.style.display = 'block';
        }
      });
    });
  }

  // Payment type handling (Full, Partial, Advance)
  const paymentTypes = document.getElementsByName('paymentType');
  const partialPaymentRow = document.getElementById('partial-payment-row');
  const remainingBalanceRow = document.getElementById('remaining-balance-row');
  const advanceAmountRow = document.getElementById('advance-amount-row');

  if (paymentTypes.length > 0) {
    paymentTypes.forEach(type => {
      type.addEventListener('change', function() {
        // Hide all payment type sections first
        if (partialPaymentRow) partialPaymentRow.style.display = 'none';
        if (remainingBalanceRow) remainingBalanceRow.style.display = 'none';
        if (advanceAmountRow) advanceAmountRow.style.display = 'none';

        // Show relevant section based on selection
        if (this.id === 'partialPaymentOption') {
          if (partialPaymentRow) partialPaymentRow.style.display = 'table-row';
          if (remainingBalanceRow) remainingBalanceRow.style.display = 'table-row';
        } else if (this.id === 'advancePaymentOption') {
          if (advanceAmountRow) advanceAmountRow.style.display = 'table-row';
        }
      });
    });
  }

 
});
</script>



<%- include('../partials/footer') %>
  
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('id') === '1') {
      // Show the new member details form
      document.getElementById('new-member-details-form').style.display = 'block';
    }
  });
</script>
  